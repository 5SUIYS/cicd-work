apiVersion: v1
kind: Secret
metadata:
  labels:
    app.kubernetes.io/component: alert-router
    app.kubernetes.io/instance: main
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 0.27.0
  name: alertmanager-main
  namespace: monitoring
stringData:
  alertmanager.yaml: |-
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'smtp.163.com:587'
      smtp_from: 'intellectzhang@163.com'
      smtp_auth_username: 'intellectzhang@163.com'
      smtp_auth_password: 'SKfGZpsABMVSvAfs'
    
    # 告警抑制规则
    inhibit_rules:
    # 严重告警抑制警告和信息告警
    - source_matchers:
      - severity = critical
      target_matchers:
      - severity =~ warning|info
      equal:
      - namespace
      - alertname
      - index_name
    
    # 警告告警抑制信息告警
    - source_matchers:
      - severity = warning
      target_matchers:
      - severity = info
      equal:
      - namespace
      - alertname
      - index_name
    
    # 节点宕机抑制该节点上的所有告警
    - source_matchers:
      - alertname = NodeDown
      target_matchers:
      - node =~ .*
      equal:
      - instance
    
    # InfoInhibitor 抑制所有信息告警
    - source_matchers:
      - alertname = InfoInhibitor
      target_matchers:
      - severity = info
      equal:
      - namespace

    # 接收器定义
    receivers:
    # 邮件接收器
    - name: email-alerts
      email_configs:
      - to: 'zhangzhili@wespoke.com'

    # 钉钉 Webhook 接收器（警告告警）
    - name: dingtalk-warning
      webhook_configs:
      - url: 'http://dingtalk-webhook.monitoring.svc.cluster.local:8080/dingtalk/webhook1/send'
        send_resolved: true

    # 语音通知接收器（严重告警）
    - name: voice-alerts
      webhook_configs:
      - url: 'http://voice-webhook-service.monitoring.svc.cluster.local:80/webhook/voice'
        send_resolved: false

    # 严重告警接收器（钉钉+语音）
    - name: critical-alerts
      webhook_configs:
      - url: 'http://dingtalk-webhook.monitoring.svc.cluster.local:8080/dingtalk/webhook1/send'
        send_resolved: true
      - url: 'http://voice-webhook-service.monitoring.svc.cluster.local:80/webhook/voice'
        send_resolved: false

    # 默认接收器
    - name: default-receiver
      email_configs:
      - to: 'zhangzhili@wespoke.com'

    # 空接收器（丢弃告警）
    - name: 'null'

    # Watchdog 接收器
    - name: 'watchdog'

    # 路由规则（告警分级处理）
    route:
      group_by:
      - namespace
      - alertname
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: default-receiver

      routes:
      # Watchdog 告警路由
      - matchers:
        - alertname = Watchdog
        receiver: watchdog
        group_wait: 0s
        repeat_interval: 1m

      # InfoInhibitor 告警丢弃
      - matchers:
        - alertname = InfoInhibitor
        receiver: 'null'

      # 严重告警 -> 钉钉+语音
      - matchers:
        - severity = critical
        receiver: critical-alerts
        group_wait: 10s
        repeat_interval: 10m

      # 警告告警 -> 邮件
      - matchers:
        - severity = warning
        receiver: email-alerts
        group_wait: 30s
        repeat_interval: 1h

      # 信息告警 -> 邮件
      - matchers:
        - severity = info
        receiver: email-alerts
        group_wait: 1m
        repeat_interval: 6h

      # 监控系统自身告警 -> 邮件
      - matchers:
        - namespace = monitoring
        receiver: email-alerts
        group_wait: 30s
        repeat_interval: 30m
type: Opaque
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: voice-webhook-config
  namespace: monitoring
data:
  template-id: "2020"
  mobile: "19299178449,18611462782" #zhangzhili,zhanghui